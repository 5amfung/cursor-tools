#!/usr/bin/env node
"use strict";var Ce=Object.create;var le=Object.defineProperty;var ke=Object.getOwnPropertyDescriptor;var Ae=Object.getOwnPropertyNames;var Se=Object.getPrototypeOf,_e=Object.prototype.hasOwnProperty;var Ge=(o,t)=>()=>(o&&(t=o(o=0)),t);var ue=(o,t)=>()=>(t||o((t={exports:{}}).exports,t),t.exports);var Te=(o,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Ae(t))!_e.call(o,s)&&s!==e&&le(o,s,{get:()=>t[s],enumerable:!(r=ke(t,s))||r.enumerable});return o};var me=(o,t,e)=>(e=o!=null?Ce(Se(o)):{},Te(t||!o||!o.__esModule?le(e,"default",{value:o,enumerable:!0}):e,o));var b,p=Ge(()=>{"use strict";b=require("url").pathToFileURL(__filename)});var pe=ue(M=>{"use strict";p();Object.defineProperty(M,"__esModule",{value:!0});var Oe=Object.defineProperty,Ne=(o,t,e)=>t in o?Oe(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e,D=(o,t,e)=>Ne(o,typeof t!="symbol"?t+"":t,e),K=class extends Error{constructor(t,e){super(t),D(this,"type"),D(this,"field"),D(this,"value"),D(this,"line"),this.name="ParseError",this.type=e.type,this.field=e.field,this.value=e.value,this.line=e.line}};function z(o){}function Re(o){let{onEvent:t=z,onError:e=z,onRetry:r=z,onComment:s}=o,i="",n=!0,a,c="",f="";function E(l){let d=n?l.replace(/^\xEF\xBB\xBF/,""):l,[w,I]=$e(`${i}${d}`);for(let A of w)u(A);i=I,n=!1}function u(l){if(l===""){k();return}if(l.startsWith(":")){s&&s(l.slice(l.startsWith(": ")?2:1));return}let d=l.indexOf(":");if(d!==-1){let w=l.slice(0,d),I=l[d+1]===" "?2:1,A=l.slice(d+I);y(w,A,l);return}y(l,"",l)}function y(l,d,w){switch(l){case"event":f=d;break;case"data":c=`${c}${d}
`;break;case"id":a=d.includes("\0")?void 0:d;break;case"retry":/^\d+$/.test(d)?r(parseInt(d,10)):e(new K(`Invalid \`retry\` value: "${d}"`,{type:"invalid-retry",value:d,line:w}));break;default:e(new K(`Unknown field "${l.length>20?`${l.slice(0,20)}\u2026`:l}"`,{type:"unknown-field",field:l,value:d,line:w}));break}}function k(){c.length>0&&t({id:a,event:f||void 0,data:c.endsWith(`
`)?c.slice(0,-1):c}),a=void 0,c="",f=""}function P(l={}){i&&l.consume&&u(i),a=void 0,c="",f="",i=""}return{feed:E,reset:P}}function $e(o){let t=[],e="",r=o.length;for(let s=0;s<r;s++){let i=o[s];i==="\r"&&o[s+1]===`
`?(t.push(e),e="",s++):i==="\r"||i===`
`?(t.push(e),e=""):e+=i}return[t,e]}M.ParseError=K;M.createParser=Re});var fe=ue(R=>{"use strict";p();Object.defineProperty(R,"__esModule",{value:!0});var Z=require("node:stream"),Le=pe(),te="connecting",de="open",q="closed",ee=()=>{};function je(o,{getStream:t}){let e=typeof o=="string"||o instanceof URL?{url:o}:o,{onMessage:r,onConnect:s=ee,onDisconnect:i=ee,onScheduleReconnect:n=ee}=e,{fetch:a,url:c,initialLastEventId:f}=Ke(e),E={...e.headers},u=[],y=r?[r]:[],k=m=>y.forEach(x=>x(m)),P=Le.createParser({onEvent:be,onRetry:Pe}),l,d=c.toString(),w=new AbortController,I=f,A=2e3,ne,G=q;return H(),{close:se,connect:H,[Symbol.iterator]:()=>{throw new Error("EventSource does not support synchronous iteration. Use `for await` instead.")},[Symbol.asyncIterator]:xe,get lastEventId(){return I},get url(){return d},get readyState(){return G}};function H(){l||(G=te,w=new AbortController,l=a(c,Ie()).then(ve).catch(m=>{l=null,!(m.name==="AbortError"||m.type==="aborted")&&ie()}))}function se(){G=q,w.abort(),P.reset(),clearTimeout(ne),u.forEach(m=>m())}function xe(){let m=[],x=[];function $(){return new Promise(g=>{let v=x.shift();v?g({value:v,done:!1}):m.push(g)})}let T=function(g){let v=m.shift();v?v({value:g,done:!1}):x.push(g)};function S(){for(y.splice(y.indexOf(T),1);m.shift(););for(;x.shift(););}function L(){let g=m.shift();g&&(g({done:!0,value:void 0}),S())}return u.push(L),y.push(T),{next(){return G===q?this.return():$()},return(){return S(),Promise.resolve({done:!0,value:void 0})},throw(g){return S(),Promise.reject(g)},[Symbol.asyncIterator](){return this}}}function ie(){n({delay:A}),G=te,ne=setTimeout(H,A)}async function ve(m){s(),P.reset();let{body:x,redirected:$,status:T}=m;if(T===204){i(),se();return}if(!x)throw new Error("Missing response body");$&&(d=m.url);let S=t(x),L=new TextDecoder,g=S.getReader(),v=!0;G=de;do{let{done:ae,value:ce}=await g.read();ce&&P.feed(L.decode(ce,{stream:!ae})),ae&&(v=!1,l=null,P.reset(),ie(),i())}while(v)}function be(m){typeof m.id=="string"&&(I=m.id),k(m)}function Pe(m){A=m}function Ie(){let{mode:m,credentials:x,body:$,method:T,redirect:S,referrer:L,referrerPolicy:g}=e,v={Accept:"text/event-stream",...E,...I?{"Last-Event-ID":I}:void 0};return{mode:m,credentials:x,body:$,method:T,redirect:S,referrer:L,referrerPolicy:g,headers:v,cache:"no-store",signal:w.signal}}}function Ke(o){let t=o.fetch||globalThis.fetch;if(!Ye(t))throw new Error("No fetch implementation provided, and one was not found on the global object.");if(typeof AbortController!="function")throw new Error("Missing AbortController implementation");let{url:e,initialLastEventId:r}=o;if(typeof e!="string"&&!(e instanceof URL))throw new Error("Invalid URL provided - must be string or URL instance");if(typeof r!="string"&&r!==void 0)throw new Error("Invalid initialLastEventId provided - must be string or undefined");return{fetch:t,url:e,initialLastEventId:r}}function Ye(o){return typeof o=="function"}var De={getStream:qe};function Me(o){return je(o,De)}function qe(o){if("getReader"in o)return o;if(typeof o.pipe!="function"||typeof o.on!="function")throw new Error("Invalid response body, expected a web or node.js stream");if(typeof Z.Readable.toWeb!="function")throw new Error("Node.js 18 or higher required (`Readable.toWeb()` not defined)");return Z.Readable.toWeb(Z.Readable.from(o))}R.CLOSED=q;R.CONNECTING=te;R.OPEN=de;R.createEventSource=Me});p();p();p();p();var O=require("node:fs"),j=require("node:path"),V=require("node:os"),Q=me(require("dotenv"),1),B={perplexity:{model:"sonar-pro",maxTokens:4e3},gemini:{model:"gemini-2.0-flash-thinking-exp-01-21",maxTokens:1e4}};function N(){try{let o=(0,j.join)(process.cwd(),"cursor-tools.config.json"),t=JSON.parse((0,O.readFileSync)(o,"utf-8"));return{...B,...t}}catch{try{let o=(0,j.join)((0,V.homedir)(),".cursor-tools","config.json"),t=JSON.parse((0,O.readFileSync)(o,"utf-8"));return{...B,...t}}catch{return B}}}function C(){let o=(0,j.join)(process.cwd(),".cursor-tools.env");if((0,O.existsSync)(o)){Q.default.config({path:o});return}let t=(0,j.join)((0,V.homedir)(),".cursor-tools",".env");if((0,O.existsSync)(t)){Q.default.config({path:t});return}}p();var Y=me(fe(),1),ze=Y.default.CLOSED,Ze=Y.default.CONNECTING,et=Y.default.OPEN,ye=Y.default.createEventSource;var ge=2,F=class{config;constructor(){C(),this.config=N()}async*fetchPerplexityResponse(t,e){let r=process.env.PERPLEXITY_API_KEY;if(!r)throw new Error("PERPLEXITY_API_KEY environment variable is not set");let s=!1,i=!1,n=!1,a=0,c=ye({url:"https://api.perplexity.ai/chat/completions",onDisconnect:()=>{n||(i?(console.error(`
Perplexity disconnected without sending a finish_reason, we will close the connection`),c.close()):(console.error(`
Connection disconnected without recieving any messages, we will retry ${ge} times (attempt ${a})`),c.close()))},fetch:async(f,E)=>{if(a++>ge)return s=!0,console.error(`
Max retries reached. Giving up.`),{body:null,url:f.toString(),status:204,redirected:!1};let u=await fetch(f,{...E,method:"POST",headers:{...E?.headers||{},Authorization:`Bearer ${r}`,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({model:e?.model||this.config.perplexity.model,messages:[{role:"system",content:"Search the web to produce answers to questions. Your responses are for an automated system and should be precise, specific and concise. Avoid unnecessary chat and formatting. Include code and examples."},{role:"user",content:t}],stream:!0,max_tokens:e?.maxTokens||this.config.perplexity.maxTokens})});if(!u.ok){let y=await u.text();throw console.error("Perplexity API error",y),new Error(`API Error (${u.status}): ${y}`)}return u}});try{for await(let{data:f,event:E}of c){try{let u=JSON.parse(f),y=u.choices[0]?.delta?.content;if(y!==void 0&&(i=!0,yield y),"finish_reason"in u.choices[0]&&u.choices[0].finish_reason){n=!0,u.citations&&u.citations.length>0&&(yield`

citations:
`+u.citations?.map((k,P)=>`${P+1}. ${k}`).join(`
`));break}if(E?.toLowerCase()==="end"||E?.toLowerCase()==="done"){n=!0;break}}catch(u){throw console.error("Error parsing event data:",u),u}if(s)break}}finally{c.close()}}async*execute(t,e){try{yield`Querying Perplexity AI using ${e?.model||this.config.perplexity.model} for: ${t}
`,yield*this.fetchPerplexityResponse(t,e)}catch(r){r instanceof Error?yield`Error: ${r.message}`:yield"An unknown error occurred"}}};p();var oe=require("node:fs"),he=require("repomix"),U=class{config;constructor(){C(),this.config=N()}async fetchGeminiResponse(t,e,r){let s=process.env.GEMINI_API_KEY;if(!s)throw new Error("GEMINI_API_KEY environment variable is not set");let i="";try{i=(0,oe.readFileSync)(".cursorrules","utf-8")}catch{}let n=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${r?.model||this.config.gemini.model}:generateContent?key=${s}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:i},{text:e},{text:t}]}],generationConfig:{maxOutputTokens:r?.maxTokens||this.config.gemini.maxTokens}})});if(!n.ok){let c=await n.text();throw new Error(`Gemini API error (${n.status}): ${c}`)}let a=await n.json();if(a.error)throw new Error(`Gemini API error: ${JSON.stringify(a.error,null,2)}`);return a.candidates[0].content.parts[0].text}async*execute(t,e){try{yield`Packing repository using repomix...
`,await(0,he.pack)(process.cwd(),{output:{filePath:"repomix-output.txt",style:"xml",fileSummary:!0,directoryStructure:!0,removeComments:!1,removeEmptyLines:!0,topFilesLength:20,showLineNumbers:!1,copyToClipboard:!1,includeEmptyDirectories:!0,parsableStyle:!0},include:["**/*"],ignore:{useGitignore:!0,useDefaultPatterns:!0,customPatterns:["**/*.pbxproj","**/node_modules/**","**/dist/**","**/build/**","**/compile/**","**/.*/**"]},security:{enableSecurityCheck:!0},tokenCount:{encoding:"cl100k_base"},cwd:process.cwd()});let r=(0,oe.readFileSync)("repomix-output.txt","utf-8");yield`Querying Gemini AI using ${e?.model||this.config.gemini.model}...
`,yield await this.fetchGeminiResponse(t,r,e)}catch(r){r instanceof Error?yield`Error: ${r.message}`:yield"An unknown error occurred"}}};p();var h=require("node:fs"),_=require("node:path"),Ee=require("node:os");var J=class{async*setupApiKeys(){C();let t=(0,_.join)((0,Ee.homedir)(),".cursor-tools",".env"),e=(0,_.join)(process.cwd(),".cursor-tools.env");if(process.env.PERPLEXITY_API_KEY&&process.env.GEMINI_API_KEY)return;let r=(s,i,n)=>{let a=`PERPLEXITY_API_KEY=${i}
GEMINI_API_KEY=${n}
`,c=(0,_.join)(s,"..");(0,h.existsSync)(c)||(0,h.mkdirSync)(c,{recursive:!0}),(0,h.writeFileSync)(s,a,"utf-8")};try{let s=process.env.PERPLEXITY_API_KEY||"",i=process.env.GEMINI_API_KEY||"";if(!s){yield"Enter your Perplexity API key (or press Enter to skip): ";let n=await new Promise(a=>{process.stdin.once("data",c=>a(c.toString().trim()))});process.env.PERPLEXITY_API_KEY=n}if(!i){yield"Enter your Gemini API key (or press Enter to skip): ";let n=await new Promise(a=>{process.stdin.once("data",c=>a(c.toString().trim()))});process.env.GEMINI_API_KEY=n}try{r(t,process.env.PERPLEXITY_API_KEY||"",process.env.GEMINI_API_KEY||""),yield`API keys written to ~/.cursor-tools/.env
`}catch(n){console.error("Error writing API keys to home directory:",n),r(e,process.env.PERPLEXITY_API_KEY||"",process.env.GEMINI_API_KEY||""),yield`API keys written to .cursor-tools.env in the current directory
`}}catch(s){console.error("Error setting up API keys:",s),yield`Error setting up API keys. You can add them later manually.
`}}async*execute(t,e){let r=e?.packageManager||"npm/yarn/pnpm",s=(0,_.join)(process.cwd(),t),i=(0,_.join)(s,"package.json");if((0,h.existsSync)(i))try{yield"Would you like to add cursor-tools as a dev dependency to package.json? (y/N): ";let n=await new Promise(a=>{process.stdin.once("data",c=>a(c.toString().trim().toLowerCase()))});if(n==="y"||n==="yes"){yield`Adding cursor-tools as a dev dependency to package.json...
`;let a=JSON.parse((0,h.readFileSync)(i,"utf-8"));a.devDependencies||(a.devDependencies={}),a.devDependencies["cursor-tools"]="latest",(0,h.writeFileSync)(i,JSON.stringify(a,null,2)),yield`Please run \`${r} install\` to complete the installation.
`}else yield`Skipping dev dependency installation.
`}catch(n){yield`Error updating package.json: ${n instanceof Error?n.message:"Unknown error"}
`;return}else yield`No package.json found - skipping dependency installation
`;yield`Checking API keys setup...
`,yield*this.setupApiKeys();try{yield`Updating .cursorrules...
`;let n=(0,_.join)(s,".cursorrules"),a=`
<cursor-tools Integration>
Use the following commands to get AI assistance:

cursor-tools web "your question"  - Get answers from the web using Perplexity AI
cursor-tools repo "your question" - Get context-aware answers about this repository using Google Gemini

cursor-tools web is good for getting up-to-date information from the web that are not repository specific. For example, you can ask it to get the names and details of the latest OpenAI models or details about an external API.
cursor-tools repo has the entire repository context available to it so it is good for repository search and tasks that require holistic understanding such as planning, debugging and answering questions about the architecture.

if cursor-tools is not found in your PATH, you can run it with \`npm exec cursor-tools "your question"\` or \`yarn cursor-tools "your question"\` or \`pnpm cursor-tools "your question"\` depending on your package manager if cursor-tools is installed as a dependency. If cursor-tools is not installed as a dependency you should fall back to using \`npx cursor-tools@latest "your question"\`.

Note: configuration is in cursor-tools.config.json (falling back to ~/.cursor-tools/config.json)
Note: api keys are loaded from .cursor-tools.env (falling back to ~/.cursor-tools/.env)
</cursor-tools Integration>
`,c="";(0,h.existsSync)(n)&&(c=(0,h.readFileSync)(n,"utf-8"));let f="<cursor-tools Integration>",E="</cursor-tools Integration>",u=c.indexOf(f),y=c.indexOf(E);if(u!==-1&&y!==-1){let k=c.slice(0,u)+a.trim()+c.slice(y+E.length);(0,h.writeFileSync)(n,k)}else(0,h.writeFileSync)(n,c+a);yield`Installation completed successfully!
`}catch(n){yield`Error updating .cursorrules: ${n instanceof Error?n.message:"Unknown error"}
`}}};p();var X=require("node:fs"),we=require("repomix"),W=class{config;constructor(){C(),this.config=N()}parseGithubUrl(t){if(t.startsWith("https://github.com/")){let r=t.replace("https://github.com/","").split("/");return{username:r[0],reponame:r[1]}}let e=t.split("/");if(e.length!==2)throw new Error("Invalid GitHub repository format. Use either https://github.com/username/reponame or username/reponame");return{username:e[0],reponame:e[1]}}async getGithubRepoContext(t){let{username:e,reponame:r}=this.parseGithubUrl(t),s=`${e}/${r}`,i=await fetch("https://api.repomix.com/api/pack",{headers:{"content-type":"application/json",Referer:"https://repomix.com/"},body:JSON.stringify({url:s,format:"xml",options:{removeComments:!1,removeEmptyLines:!0,showLineNumbers:!1,fileSummary:!0,directoryStructure:!0,outputParsable:!1},signal:{}}),method:"POST"});if(!i.ok)throw new Error(`Failed to fetch GitHub repository context: ${i.statusText}`);return await i.text()}async fetchGeminiDocResponse(t,e){let r=process.env.GEMINI_API_KEY;if(!r)throw new Error("GEMINI_API_KEY environment variable is not set");let s=`Generate comprehensive documentation for the following repository.
Focus on:
1. Repository purpose and main features
2. Project structure and key components
3. How to install and use the project
4. Key APIs and interfaces (if applicable)
5. Dependencies and requirements

Use clear, professional language and format the documentation in markdown.

Repository Context:
${t}`,i=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${e?.model||this.config.gemini.model}:generateContent?key=${r}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:s}]}],generationConfig:{maxOutputTokens:e?.maxTokens||this.config.gemini.maxTokens}})});if(!i.ok){let a=await i.text();throw new Error(`Gemini API error (${i.status}): ${a}`)}let n=await i.json();if(n.error)throw new Error(`Gemini API error: ${JSON.stringify(n.error,null,2)}`);return n.candidates[0].content.parts[0].text}async*execute(t,e){try{yield`Generating repository documentation...
`;let r;e?.fromGithub?(yield`Fetching repository context for ${e.fromGithub}...
`,r=await this.getGithubRepoContext(e.fromGithub)):(yield`Packing local repository using repomix...
`,await(0,we.pack)(process.cwd(),{output:{filePath:".repomix-doc-temp.txt",style:"xml",fileSummary:!0,directoryStructure:!0,removeComments:!1,removeEmptyLines:!0,topFilesLength:20,showLineNumbers:!1,copyToClipboard:!1,includeEmptyDirectories:!0,parsableStyle:!0},include:["**/*"],ignore:{useGitignore:!0,useDefaultPatterns:!0,customPatterns:["**/*.pbxproj","**/node_modules/**","**/dist/**","**/build/**","**/compile/**","**/.*/**"]},security:{enableSecurityCheck:!0},tokenCount:{encoding:"cl100k_base"},cwd:process.cwd()}),r=(0,X.readFileSync)(".repomix-doc-temp.txt","utf-8")),yield`Generating documentation using Gemini AI...
`;let s=await this.fetchGeminiDocResponse(r,e);e?.output?((0,X.writeFileSync)(e.output,s),yield`Documentation saved to ${e.output}
`):(yield`
--- Repository Documentation ---

`,yield s,yield`

--- End of Documentation ---
`),yield`Documentation generation completed!
`}catch(r){r instanceof Error?yield`Error: ${r.message}`:yield"An unknown error occurred"}}};var re={web:new F,repo:new U,install:new J,doc:new W};async function Fe(){let[,,o,...t]=process.argv,e={},r=[];for(let n=0;n<t.length;n++){let a=t[n];if(a.startsWith("--")){let[c,f]=a.slice(2).split("=");c==="model"?e.model=f:c==="maxTokens"&&(e.maxTokens=parseInt(f,10),isNaN(e.maxTokens)&&(console.error("Error: maxTokens must be a number"),process.exit(1)))}else r.push(a)}let s=o==="install"&&r.length===0?".":r.join(" ");(!o||!s)&&(console.error('Usage: cursor-tools [--model=<model>] [--maxTokens=<number>] <command> "<query>"'),process.exit(1));let i=re[o];i||(console.error(`Unknown command: ${o}`),console.error("Available commands: "+Object.keys(re).join(", ")),process.exit(1));try{for await(let n of i.execute(s,e))await new Promise(a=>process.stdout.write(n,a));console.log("")}catch(n){console.error("Error:",n),process.exit(1)}}Fe().then(()=>{process.exit(0)}).catch(o=>{console.error("Error in cursor-tools:",o),process.exit(1)});
